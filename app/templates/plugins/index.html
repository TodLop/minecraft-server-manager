{% extends "admin_base.html" %}

{% block title %}Plugin Documentation - Project Octopus{% endblock %}

{% import "components/nearoutpost/macros.html" as near %}

{% block content %}
<div x-data="pluginsOverview()" x-init="init()" class="min-h-screen bg-[#050505] text-slate-300 font-sans">

    {% include "components/nearoutpost/background_pattern.html" %}

    <!-- Navbar -->
    <header class="sticky top-0 z-30 border-b border-purple-500/20 bg-[#0a0a0a]/80 backdrop-blur-xl">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center gap-4">
                    {{ near.back_button('/minecraft/admin' if is_admin else '/minecraft/staff') }}
                    <div class="flex items-center gap-3">
                        <div class="plugin-badge px-3 py-1.5 rounded-lg">
                            <span class="text-xs font-bold text-white tracking-wider">PLUGINS</span>
                        </div>
                        <div>
                            <h1 class="text-lg font-bold text-white tracking-tight">
                                Plugin Documentation
                            </h1>
                            <p class="text-xs text-slate-500">{{ plugins|length }} tracked plugins</p>
                        </div>
                    </div>
                </div>

                <div class="flex items-center gap-4">
                    <!-- Notifications -->
                    <button @click="showNotifications = !showNotifications" class="relative p-2 rounded-lg bg-slate-800/50 hover:bg-slate-800 border border-slate-700/50 transition-all">
                        <i data-lucide="bell" class="w-5 h-5 text-slate-400"></i>
                        {% if unread_count > 0 %}
                        <span class="notification-badge absolute -top-1 -right-1 w-5 h-5 rounded-full text-xs font-bold text-white flex items-center justify-center">
                            {{ unread_count if unread_count < 10 else '9+' }}
                        </span>
                        {% endif %}
                    </button>

                    <!-- User Info -->
                    <div class="hidden sm:flex items-center gap-3 px-4 py-2 rounded-xl bg-slate-800/50 border border-slate-700/50">
                        <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-purple-500 to-purple-600 flex items-center justify-center">
                            <span class="text-sm font-bold text-white">{{ (user_info.name or user_info.email)[0] | upper }}</span>
                        </div>
                        <div class="flex flex-col">
                            <span class="text-sm font-medium text-white">{{ user_info.name or 'User' }}</span>
                            <span class="text-xs text-slate-500">{{ 'Admin' if is_admin else 'Staff' }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Notifications Dropdown -->
    <div x-show="showNotifications" x-transition @click.outside="showNotifications = false"
        class="fixed top-20 right-4 z-50 w-96 max-h-[500px] glass-card rounded-xl overflow-hidden">
        <div class="p-4 border-b border-slate-700/50 flex items-center justify-between">
            <h3 class="font-semibold text-white">Notifications</h3>
            <button @click="markAllRead()" class="text-xs text-purple-400 hover:text-purple-300">Mark all read</button>
        </div>
        <div class="overflow-y-auto max-h-[400px]">
            <template x-if="notifications.length === 0">
                <div class="p-8 text-center text-slate-500">
                    <i data-lucide="bell-off" class="w-8 h-8 mx-auto mb-2 opacity-50"></i>
                    <p class="text-sm">No notifications</p>
                </div>
            </template>
            <template x-for="notif in notifications" :key="notif.id">
                <a :href="`/plugins/${notif.plugin_id}`"
                    class="block p-4 border-b border-slate-700/30 hover:bg-slate-800/50 transition-colors">
                    <div class="flex items-start gap-3">
                        <div class="w-8 h-8 rounded-lg bg-purple-500/20 flex items-center justify-center flex-shrink-0">
                            <i data-lucide="file-text" class="w-4 h-4 text-purple-400"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm text-white" x-text="notif.message"></p>
                            <p class="text-xs text-slate-500 mt-1">
                                <span x-text="notif.actor_name"></span> &middot;
                                <span x-text="formatTime(notif.timestamp)"></span>
                            </p>
                        </div>
                    </div>
                </a>
            </template>
        </div>
    </div>

    <main class="relative max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

        <!-- Filter Tabs -->
        <div class="flex flex-wrap gap-2 mb-6">
            <button @click="filter = 'all'"
                class="px-4 py-2 rounded-lg text-sm font-medium border transition-all"
                :class="filter === 'all' ? 'bg-purple-500/20 border-purple-500/50 text-purple-300' : 'bg-slate-800/40 border-slate-700/50 text-slate-400 hover:border-slate-600'">
                All ({{ plugins|length }})
            </button>
            <button @click="filter = 'documented'"
                class="px-4 py-2 rounded-lg text-sm font-medium border transition-all"
                :class="filter === 'documented' ? 'bg-emerald-500/20 border-emerald-500/50 text-emerald-300' : 'bg-slate-800/40 border-slate-700/50 text-slate-400 hover:border-slate-600'">
                Documented
            </button>
            <button @click="filter = 'undocumented'"
                class="px-4 py-2 rounded-lg text-sm font-medium border transition-all"
                :class="filter === 'undocumented' ? 'bg-amber-500/20 border-amber-500/50 text-amber-300' : 'bg-slate-800/40 border-slate-700/50 text-slate-400 hover:border-slate-600'">
                Needs Docs
            </button>

            <!-- Search -->
            <div class="flex-1"></div>
            <div class="relative">
                <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-600"></i>
                <input type="text" x-model="search" placeholder="Search plugins..."
                    class="w-48 pl-10 pr-4 py-2 rounded-lg bg-slate-800/40 border border-slate-700/50 text-sm text-white placeholder-slate-500 focus:outline-none focus:border-purple-500/50">
            </div>
        </div>

        <!-- Plugins Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            {% for plugin in plugins %}
            <a href="/minecraft/plugins/{{ plugin.id }}"
                x-show="matchesFilter('{{ plugin.id }}', {{ 'true' if plugin.has_docs else 'false' }}, '{{ plugin.name }}')"
                class="glass-card glass-card-hover glass-card-float-hover rounded-xl p-5 block">
                <div class="flex items-start gap-4">
                    <!-- Plugin Icon -->
                    <div class="w-12 h-12 rounded-lg bg-gradient-to-br from-purple-500 to-purple-600 flex items-center justify-center flex-shrink-0 overflow-hidden">
                        {% if plugin.icon_url %}
                        <img src="{{ plugin.icon_url }}" alt="{{ plugin.name }}" class="w-full h-full object-cover">
                        {% else %}
                        <span class="text-lg font-bold text-white">{{ plugin.id[:2].upper() }}</span>
                        {% endif %}
                    </div>

                    <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-2 mb-1">
                            <h3 class="font-semibold text-white truncate">{{ plugin.name }}</h3>
                            <span class="source-badge source-{{ plugin.source }}">{{ plugin.source }}</span>
                        </div>
                        <p class="text-xs text-slate-500 mb-2">v{{ plugin.version }}</p>

                        {% if plugin.summary %}
                        <p class="text-sm text-slate-400 line-clamp-2">{{ plugin.summary }}</p>
                        {% else %}
                        <p class="text-sm text-slate-600 italic">No documentation yet</p>
                        {% endif %}

                        <div class="flex items-center gap-4 mt-3 text-xs text-slate-500">
                            {% if plugin.commands_count > 0 %}
                            <span class="flex items-center gap-1">
                                <i data-lucide="terminal" class="w-3 h-3"></i>
                                {{ plugin.commands_count }} commands
                            </span>
                            {% endif %}
                            {% if plugin.comments_count > 0 %}
                            <span class="flex items-center gap-1">
                                <i data-lucide="message-square" class="w-3 h-3"></i>
                                {{ plugin.comments_count }} comments
                            </span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </a>
            {% endfor %}
        </div>

        <!-- Empty State -->
        <div x-show="filteredCount === 0" class="text-center py-16 text-slate-500">
            <i data-lucide="search-x" class="w-12 h-12 mx-auto mb-4 opacity-50"></i>
            <p>No plugins match your filter</p>
        </div>

    </main>
</div>

<script>
function pluginsOverview() {
    return {
        filter: 'all',
        search: '',
        showNotifications: false,
        notifications: [],
        filteredCount: {{ plugins|length }},

        init() {
            lucide.createIcons();
            this.loadNotifications();
        },

        matchesFilter(id, hasDocs, name) {
            // Search filter
            if (this.search && !name.toLowerCase().includes(this.search.toLowerCase())) {
                return false;
            }

            // Tab filter
            if (this.filter === 'documented' && !hasDocs) return false;
            if (this.filter === 'undocumented' && hasDocs) return false;

            return true;
        },

        async loadNotifications() {
            try {
                const res = await fetch('/minecraft/plugins/api/notifications?limit=20');
                const data = await res.json();
                if (data.status === 'ok') {
                    this.notifications = data.notifications;
                }
                this.$nextTick(() => lucide.createIcons());
            } catch (e) {
                console.error('Failed to load notifications:', e);
            }
        },

        async markAllRead() {
            try {
                await fetch('/minecraft/plugins/api/notifications/mark-read', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });
                this.notifications = this.notifications.map(n => ({ ...n, read: true }));
            } catch (e) {
                console.error('Failed to mark notifications as read:', e);
            }
        },

        formatTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diff = (now - date) / 1000;

            if (diff < 60) return 'Just now';
            if (diff < 3600) return Math.floor(diff / 60) + 'm ago';
            if (diff < 86400) return Math.floor(diff / 3600) + 'h ago';
            return date.toLocaleDateString();
        }
    }
}
</script>
{% endblock %}
